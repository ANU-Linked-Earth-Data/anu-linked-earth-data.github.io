"use strict";angular.module("services.config",[]).constant("config",{"sparql-endpoints":["//anulinkedearth.org/landsat/query"]}),angular.module("LEDApp",["services.config","ngRoute","ngMessages","rzModule","leaflet-directive","chart.js"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/search.html",controller:"SearchController",controllerAs:"sc"}).otherwise({redirectTo:"/"})}]),angular.module("LEDApp").controller("SearchController",["SearchService","$scope","$compile",function(a,b,c){function d(a){var b=a.match(/-?\d+.?\d* -?\d+.?\d*,/g);return[b[0].match(/-?\d+.?\d*/g).reverse(),b[2].match(/-?\d+.?\d*/g).reverse()]}var e=this;this.hasSearched=!1;var f,g;e.bands=null;var h=[],i=[],j=[];e.currentOverlay=[],e.bandLayer=0;var k=L.map("mapid").setView([-34.6,148.33],9);k.on("zoomend",function(){e.performQueryLimitTime(k.getZoom()-5,f)}),k.on("moveend",function(){e.onMoveMap(g,f)}),L.tileLayer("https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}",{attribution:'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',maxZoom:18,id:"duo.034p8op4",accessToken:"pk.eyJ1IjoiZHVvIiwiYSI6ImNpbm52Y2lxdzB6emZ0dmx5MmNmNGZnejMifQ._yO4cALvQUPwvtVj_nUYEA"}).addTo(k);var l=L.control({position:"topright"});l.onAdd=function(){return this._div=L.DomUtil.create("div","info"),this.update(),this._div},l.update=function(a){if(void 0!==a){var b=a.subject.value,c=Number(a.lat.value),d=Number(a.lon.value);this._div.innerHTML="<h4>Image Details</h4>",this._div.innerHTML+='<a href="'+b+'">Link</a>',this._div.innerHTML+="<p>Band:"+a.band.value+"</p>",this._div.innerHTML+="<p>Pixel:"+a.dggsLevelPixel.value+"</p>",this._div.innerHTML+="<p>Square:"+a.dggsLevelSquare.value+"</p>",this._div.innerHTML+="<p>Resolution:"+a.resolution.value+"</p>",this._div.innerHTML+="<p>Location: ("+Math.round(100*(c+1e-5))/100+", "+Math.round(100*(d+1e-5))/100+")</p>"}else this._div.innerHTML="<h4>Image Details</h4><p>None Selected</p>"},l.addTo(k);var m=L.control({position:"bottomright"});m.onAdd=function(){var a=L.DomUtil.create("div"),d=L.DomUtil.create("div","",a);d.setAttribute("ng-include","'views/charts/barchart.html'");var e=b.$new();return c(a)(e),a},m.update=function(a){},m.addTo(k),b.search=function(){},e.getMessage=function(){},a.getDistinctTime().then(function(a){var c=[];e.dict=[],e.display=[];for(var d in a.results.bindings)c.push(a.results.bindings[d].timePeriod.value);for(d in c)e.dict[moment(c[d]).format("DD/MM/YY, h:mm:ss a")]=c[d],e.display.push(moment(c[d]).format("DD/MM/YY, h:mm:ss a"));c.length>0&&e.performQueryLimitTime(k.getZoom()-5,c[c.length-1]),b.sliderDate={value:e.display.length-1,showTicks:!0,options:{stepsArray:e.display,onStart:function(){},onChange:function(){},onEnd:function(){f!==e.dict[b.sliderDate.value]&&e.performQueryLimitTime(g,e.dict[e.display[b.sliderDate.value]])}}}});var n=function(a){null!=a&&(l.update(a),console.log(a.dggsCell.value),b.$broadcast("onSelectRegion",a.dggsCell.value,a.band.value))};e.performQueryLimitTime=function(b,c){f=c,g=b,a.getDistinctBands().then(function(a){h=[],i=[],e.bands=a;for(var d in a)d.toString(),h.push([]),i.push([]);e.onMoveMap(b,c)})},e.onMoveMap=function(b,c){null==e.bands?e.performQueryLimitTime(b,c):a.performQueryLimitTime(b,c).then(function(a){var b=a.results.bindings;null==e.imageDict&&(e.imageDict=[]);for(var c in e.currentOverlay)k.removeLayer(e.currentOverlay[c]);for(;0!=j.length;)k.removeLayer(j.pop());e.currentOverlay=[];var f=function(a){n(e.imageDict[a.target.src])};for(c in b){e.imageDict[b[c].value.value]=b[c];var g=d(String(b[c].geoSparql.value)),l=new L.imageOverlay(b[c].value.value,g,{interactive:!0});e.currentOverlay.push(l),b[c].subject.value in i||(h[Number(b[c].band.value)].push(l),i[Number(b[c].band.value)].push(b[c].subject.value))}var m={};for(c in e.bands)m[c]=L.featureGroup(h[c]);if(null!=e.layer&&null!=e.layers){for(var o in e.layers)e.layer.removeLayer(e.layers[o]);for(o in m)e.layer.addBaseLayer(m[o],o);e.bandLayer<m.length?(m[e.bandLayer].addTo(k),j.push(m[e.bandLayer])):(m[0].addTo(k),j.push(m[0]))}else e.layer=L.control.layers(m,null),k.on("baselayerchange",function(a){e.bandLayer=Number(a.name),a.layer.on("click",function(){console.log("Clicked on a group!")})}),e.layer.addTo(k),m[0].addTo(k),j.push(e.layer),j.push(m[0]),k.on("click",function(a){f(a.originalEvent)});e.layers=m})}}]),angular.module("LEDApp").controller("ChartController",["$scope","SearchService",function(a,b){var c=this;a.$on("onSelectRegion",function(a,b,d){c.performQueryLimitLocation(b,d)}),c.performQueryLimitLocation=function(c,d){b.performQueryLimitLocation(c,d).then(function(b){var c=b.results.bindings,d=[],e=[];for(var f in c)d.push(moment(c[f].timePeriod.value).format("DD/MM/YY, h:mm:ss a")),e.push(Number(c[f].value.value).toFixed(2));a.data=[e],a.labels=d})},a.barOptions={responsive:!0,scaleBeginAtZero:!1,scaleShowGridLines:!0,scaleGridLineColor:"rgba(255,255,255,.5)",scaleGridLineWidth:1,barShowStroke:!0,barStrokeWidth:.1,barValueSpacing:2,barDatasetSpacing:1,scales:{xAxes:[{display:!1}]}},a.labels=["2006","2007","2008","2009","2010","2011","2012"],a.series=["Values"],a.data=[[0,0,0,0,0,0,0]]}]),angular.module("LEDApp").factory("SPARQLEndpoint",["$http","$q","config",function(a,b,c){var d={};return a.defaults.useXDomain=!0,d._urls=c["sparql-endpoints"],d._getURL=function(){return b(function(b,c){if("_url"in this)return void b(this._url);var d=this._urls.shift();if(void 0===d)return void c("Couldn't find a working endpoint URL");var e={method:"GET",url:d,params:{query:"DESCRIBE <>"},headers:{Accept:"application/sparql-results+json,*/*;q=0.9"}};a(e).then(function(){this._url=d,console.info("Selected endpoint: "+this._url),b(this._url)}.bind(this),function(a){console.warn("Endpoint "+d+" down, status: "+a.status),this._getURL().then(b,c)}.bind(this))}.bind(this))}.bind(d),d.query=function(c){return b(function(b,d){this._getURL().then(function(b){var d={method:"GET",url:b,params:{query:c},headers:{Accept:"application/sparql-results+json,*/*;q=0.9"}};return a(d)}).then(function(a){b(a.data)},function(a){d(a)})}.bind(d))},d}]),angular.module("LEDApp").factory("SearchService",["$http","SPARQLEndpoint",function(a,b){var c={},d=["PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>","PREFIX led: <http://www.example.org/ANU-LED#>","PREFIX geo: <http://www.w3.org/2003/01/geo/wgs84_pos#>","PREFIX qb:  <http://purl.org/linked-data/cube#>"],e=["?subject led:etmBand ?band .","?subject led:bounds ?geoSparql .","?subject led:time ?timePeriod .","?subject led:resolution ?resolution .","?subject led:location ?location .","?subject led:dggsLevelPixel ?dggsLevelPixel .","?subject led:dggsLevelSquare ?dggsLevelSquare .","?subject led:dggsCell ?dggsCell .","?location geo:lat ?lat .","?location geo:lon ?lon ."],f="SELECT ?subject ?geoSparql ?timePeriod ?band ?value ?resolution ?lon ?lat ?dggsLevelSquare ?dggsLevelPixel ?dggsCell",g="SELECT DISTINCT ?subject ?geoSparql ?timePeriod ?band ?value ?resolution ?lon ?lat ?dggsLevelSquare ?dggsLevelPixel",h="ORDER BY ASC(?timePeriod)",i=["SELECT DISTINCT ?timePeriod WHERE {","?subject a qb:Observation .","?subject led:time ?timePeriod","} ORDER BY ASC(?timePeriod)"].join("\n"),j=["SELECT DISTINCT ?band WHERE {","?subject a qb:Observation .","?subject led:etmBand ?band","} ORDER BY ASC(?band)"].join("\n");return c.getDistinctTime=function(){return b.query(d.join("\n")+"\n"+i)},c.getDistinctBands=function(){return b.query(d.join("\n")+"\n"+j).then(function(a){var b=[];for(var c in a.results.bindings)b.push(a.results.bindings[c].band.value);return b})},c.performQueryLimitLocation=function(a,c){var f=d.join("\n")+g+"\nWHERE {\n ?subject a led:Pixel .?subject led:value ?value . \n"+e.join("\n")+'\nFILTER(?dggsCell = "'+a+'" && ?band = '+c+")}"+h,i=b.query(f);return i.then(function(a){var b=a.results.bindings;b.toString()}),i},c.performQueryLimitTime=function(a,c){var g=d.join("\n")+f+"\nWHERE {\n ?subject a led:GridSquare .?subject led:imageData ?value .  \n"+e.join("\n")+'\nFILTER(?timePeriod = "'+c+'"^^xsd:datetime && ?dggsLevelSquare = '+a+")}"+h,i=b.query(g);return i},c}]),angular.module("LEDApp").run(["$templateCache",function(a){a.put("views/charts/barchart.html",'<!-- Sourced from https://github.com/ANU-WALD/aus-env/blob/master/app/views/details/bar.html --> <div ng-controller="ChartController" class="chart-holder"> <h2 class="details-heading">Values Chart</h2> <h3 class="chart-title"> {{bar.title}} <i class="fa fa-info-circle" uib-tooltip="{{bar.description}}" tooltip-append-to-body="true"></i> </h3> <div> <canvas id="bar" class="chart chart-bar" chart-data="data" chart-labels="labels" chart-series="series" chart-options="barOptions"> </canvas> <!-- chart-options="barOptions" chart-colours="barColors"\n\n         <a class="download-link" ng-show="bar.download" ng-href="{{bar.download}}"><i class="fa fa-download"></i>&nbspGet the data</a> --> <!-- <span class="pull-right" ng-show="selectedRegionArea">Area: {{selectedRegionArea | number}} km<sup>2</sup></span> --> <!-- <div class="text-center verticaltext_content chart-vertical-position"><span ng-bind-html="bar.units"/></div> --> </div> </div>'),a.put("views/charts/chartHolder.html",'<div class="hidden-xs"> <div class="details-map-tool"> </div> </div>'),a.put("views/charts/timeSeries.html",'<!-- Sourced from https://github.com/ANU-WALD/aus-env/blob/master/app/views/details/timeseries.html --> Test <canvas id="lineserieschart" class="chart chart-line" chart-options="lineOptions" chart-data="lineData" chart-labels="lineLabels" chart-legend="false" chart-series="lineSeries" chart-click="onLineClick" chart-hover="onLineHover"> </canvas>'),a.put("views/search.html",'<nav class="navbar navbar-default navbar-static-top"> <div class="container-fluid"> <!-- Brand and toggle get grouped for better mobile display --> <div class="navbar-header"> <a class="navbar-brand" href="#/">ANU Linked Earth Observations</a> </div> <form class="navbar-form navbar-right"> <div class="form-group"> <rzslider rz-slider-model="sliderDate.value" rz-slider-options="sliderDate.options"> </rzslider> </div> </form> <!-- <div ng-include="\'views/charts/barchart.html\'"></div> --> </div><!-- /.container-fluid --> </nav> <div ng-class="{\'search-result\': sc.hasSearched, \'search-new\': !sc.hasSearched}" ng-cloak="ng-cloak"> <md-content> </md-content> <div class="jumbotron search-show-hide" ng-show="sc.hasSearched" style="clear:both"> <p>Search Result: {{sc.message}}</p> </div> </div> <leaflet id="mapid" center="mapCenter" controls layers="layers" defaults="defaults"></leaflet>')}]);